services:
  db:                 # mariadb für mac
    # docker MySQL database with persistent storage.
    # image: mysql:8.0
    # image: mariadb:10.6.4-focal
    # MariaDB only creates databases on startup using the MYSQL_DATABASE env variable — and only one database can be created this way.
    container_name: "${COMPOSE_PROJECT_NAME}-mysql"
    image: mariadb:latest
    ports:
      - ${IP}:3307:3307 # change ip if required

    volumes:
      - db_data:/var/lib/mysql
      - ./init-db:/docker-entrypoint-initdb.d # this will hold the sql to create the tables in the database

    restart: always

    # Key Rules:MYSQL_DATABASE only works on first container startup (i.e., no existing volume).
    # Any .sql files in /docker-entrypoint-initdb.d run only on first startup too.
    # If the volume already exists, MySQL skips re-initializing. 
    # The db is only created if db data is empty
    # 

    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: d3_articles

    command: >
      --default-authentication-plugin=mysql_native_password

  phpmyadmin:         # depends on DB https://docs.phpmyadmin.net/en/latest/setup.html#docker-environment-variables

    container_name: "${COMPOSE_PROJECT_NAME}-phpmyadmin"
    
    depends_on:
      - db

    image: arm64v8/phpmyadmin
    
    ports:
      - ${PHP_MY_ADMIN_PORT}:80

    environment:
      PMA_HOST: db
      UPLOAD_LIMIT: 500M
      MEMORY_LIMIT: 1010M
      MAX_EXECUTION_TIME: 100000
      MYSQL_ROOT_PASSWORD: "${DB_ROOT_PASSWORD}"
  
  apache:
    container_name: "${COMPOSE_PROJECT_NAME}-apache"
    image: php:8.1-apache  # or another PHP version
    ports:
      - "8181:80"    # prod site
      - "8182:8182"  # stg site (via virtual host on port 8182)
    volumes:
      - ./prod:/var/www/prod
      - ./stg:/var/www/stg
      - ./input-data/prd.conf:/etc/apache2/sites-enabled/prd.conf #vhosts
      - ./input-data/stg.conf:/etc/apache2/sites-enabled/stg.conf #vhosts
    depends_on:
      - db
    restart: always

volumes:
    input-data:
    db_data:
    prd:
    stg: 